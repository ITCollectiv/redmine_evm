<h2 id="evm-title"><%=l(:title_evm_tab)%></h2>
<% html_title('EVM Indicators') %>
<p id="evm-subtitle"><%=l(:subtitle_evm_tab)%></p>

<% if @project.baselines.any? %>

    <div id="evm-summary">
        <!-- Gauges -->
        <h3><%= l(:subtitle_evm_summary)%></h3>
        <div id="evm-summary-indicators">
            <div class="gauge-container">
                <h5>Schedule Performance Index</h5>
                <canvas id="spi" class="evm-gauge"></canvas>
                <p>SPI = <span id="spi-value"></span></p>
                <p>Behind Schedule < 1 < Ahead Schedule</p>
            </div>
            <div class="gauge-container">
                <h5>Cost Performance Index</h5>
                <canvas id="cpi" class="evm-gauge"></canvas>
                <p>CPI = <span id="cpi-value"></span></p>
                <p>Over Budget < 1 < Under Budget</p>


                <h5>Schedule Variance:</h5>
                <p>SV = EV - PV = <span id="sv-value"></span></p>
                <h5>Cost Variance:</h5>
                <p>CV = EV - AC = <span id="cv-value"></span></p>
                <h5>Project start date:</h5><p> <%=@project.start_date.to_date%></p>
                <h5>Project due date:</h5><p> <%=@project.due_date.to_date%></p>

            </div>
        </div>
    </div>

    <!-- Dropdown for baselines -->
    <br>
    <h3 id="evm-label-select-baseline"><%=l(:label_select_baseline) %></h3>
    <div class="styled-select">
        <%= collection_select :baseline, :id, @baselines, :id, :name, :remote => true %>
    </div>

    <!-- Main Chart -->
    <br>
    <div id="evm-main-chart"></div>
    <!-- Versions Chart -->
    <br>
    <h3>Versions</h3>
    <div id="evm-versions-charts"></div>

    <%= javascript_include_tag 'jquery',        :plugin => 'redmine_evm' %>
    <%= javascript_include_tag 'flot',          :plugin => 'redmine_evm' %>
    <%= javascript_include_tag 'flottime',      :plugin => 'redmine_evm' %>
    <%= javascript_include_tag 'flotlabel',     :plugin => 'redmine_evm' %>
    <%= javascript_include_tag 'gaugemin',      :plugin => 'redmine_evm' %>
    <%= javascript_include_tag 'drawchartgauge',:plugin => 'redmine_evm' %>
    <%= stylesheet_link_tag    'evm' ,          :plugin => 'redmine_evm' %>

    <!-- This script is the ajax way to select baselines from dropdown box -->
    <script>
            var dropdownMenu = $('#baseline_id');    //Dropdown element from html.  
            var projectId    = <%= @project.id %> ;  //The current project id;
            var baselineId   = dropdownMenu.val();   //The dropdown selected baseline id;
            
            var mainChartData;
            var mainChartHtmlElement;
            var versionsChartData;
            var verisonChartHtmlElement;

            var plannedValue;
            var earnedValue;
            var actualCost;
            var cpi;
            var spi;
            var scheduleVariance;
            var costVariance;

            var urlMainChartData;       //Get json for chart data, from baselines_controller.
            var urlVersionsChartData;   //Get json for versions chart data, from baselines_controller.
            var urlEvmVariables;        //Get json for evms data, from baselines_controller.

            function getEvmData(url){ 
                var data;
                $.ajax({
                    async: false,       //Whithout this it would not return the json data in var data, for now 
                    url: url,
                    type: "GET",
                    dataType: "json",
                    success: function(resp) {
                        data = resp
                    }
                });
                console.log(data);      //DEBUG Remove after
                return data;
            }

            function renderEvmData(){
                urlMainChartData        = '/projects/' + projectId + '/baselines/' + baselineId + '/chart_data';
                urlVersionsChartData    = '/projects/' + projectId + '/baselines/' + baselineId + '/versions_chart_data';
                urlEvmVariables         = '/projects/' + projectId + '/baselines/' + baselineId + '/evm_variables';

                //Draw the main Chart.
                mainChartData = getEvmData(urlMainChartData);
                mainChartHtmlElement = 'evm-graph-lines-' + baselineId;
                $('#evm-main-chart').html(
                    '<div id=' + mainChartHtmlElement + ' style="width:50%;height:300px;"></div>'  //style goes to CSS
                );
                drawChart(mainChartData, mainChartHtmlElement);

                //Draw versions Charts
                versionsChartContainer = $('#evm-versions-charts');
                versionsChartData = getEvmData(urlVersionsChartData);
                versionsChartContainer.empty();
                $.each(versionsChartData, function(key, value) {  
                  verisonChartHtmlElement = 'evm-graph-lines-version-' + key;
                  versionsChartContainer.append(
                     '<h5>'+ versionsChartData[key].name +'</h5><div id=' + verisonChartHtmlElement + ' style="width:50%;height:300px;"></div>'
                  );
                  drawChart(value, verisonChartHtmlElement);
                });

                //Draw Gauges
                evmVariables = getEvmData(urlEvmVariables);
                plannedValue = evmVariables['pv'];
                actualCost   = evmVariables['ac'];
                earnedValue  = evmVariables['ev'];
                spi = earnedValue / plannedValue ;
                cpi = earnedValue / actualCost ;
                drawGauge(spi * 1000, 'spi');
                drawGauge(cpi * 1000, 'cpi');
                $('#spi-value').html(spi.toFixed(3).toString());  //toFixed is the number of decimal 
                $('#cpi-value').html(cpi.toFixed(3).toString());

                //Schedule Variance and Cost Variance
                scheduleVariance = earnedValue - plannedValue;
                costVariance     = earnedValue - actualCost;
                $('#sv-value').html(scheduleVariance.toFixed(3).toString());
                $('#cv-value').html(costVariance.toFixed(3).toString());
            }

            //Render data from current baseline.
            renderEvmData();
            
            //Render data after changing the baseline from dropdown menu.
            dropdownMenu.change(function() {
                baselineId = $(this).val();
                renderEvmData();
            });     
    </script>

<% else %>
    <p class="nodata"><%= l(:label_no_data) %> <%= link_to l(:label_baseline_set), new_project_baseline_path(@project, :back_url => ''), :class => 'icon icon-add' %></p>
<% end %>