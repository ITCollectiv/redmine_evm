<%= javascript_include_tag 'jquery',        :plugin => 'redmine_evm' %>
<%= javascript_include_tag 'flot',          :plugin => 'redmine_evm' %>
<%= javascript_include_tag 'flottime',      :plugin => 'redmine_evm' %>
<%= javascript_include_tag 'flotlabel',     :plugin => 'redmine_evm' %>
<%= javascript_include_tag 'gaugemin',      :plugin => 'redmine_evm' %>
<%= javascript_include_tag 'drawchartgauge',:plugin => 'redmine_evm' %>
<%= stylesheet_link_tag    'evm' ,          :plugin => 'redmine_evm' %>
    
<h2 id="evm-title"><%=l(:title_evm_tab)%></h2>
<% html_title('EVM Indicators') %>
<p id="evm-subtitle"><%=l(:subtitle_evm_tab)%></p>

<% if @project.baselines.any? %>

    <% content_for :sidebar do %>
        <div id="evm-summary">
            <h3><%= l(:subtitle_evm_summary) %></h3>
            <div id="evm-summary-indicators">
                <div class="gauge-container">
                    <h5><%= l(:label_project_schedule) %></h5> 
                    <!--<canvas id="spi" class="evm-gauge"></canvas>-->
                    <div id="evm-spi-bars-container" class="evm-bars-container">

                    </div>
                    <p><b>The project is <span id="evm-spi-status-percentage"></span></b>
                    <br><span id='evm-spi-status-label'></span> schedule</p>
                </div>
                <div class="gauge-container">
                    <h5><%= l(:label_project_cost) %></h5>
                    <!--<canvas id="cpi" class="evm-gauge"></canvas>-->
                    <div id="evm-cpi-bars-container" class="evm-bars-container">
                       
                    </div>
                    <div id="evm-cpi-barchart"></div>
                    <p><b>The project is <span id="evm-cpi-status-percentage"></span></b>
                    <br><span id='evm-cpi-status-label'></span> budget</p>
                </div>
            </div>
        </div>
    <% end %>

    <!-- Dropdown for baselines -->
    <fieldset id="filters" class="collapsible">
      <legend onclick="toggleFieldset(this);"><%= l(:label_baseline_plural) %></legend>
      <br>
        <div class="styled-select">
            <%= collection_select :baseline, :id, @baselines, :id, :name, :remote => true %>
        </div>
    </fieldset>

    <div id="evm-charts-wrapper">
        <!-- Main Chart -->
        <div id="evm-main-chart"></div>
        <!-- Versions Chart -->
        <div id="evm-versions-charts"></div>
    </div>

    <div id="evm-legend-info">
        <div id="evm-legend-content">
            <div>
                <h3 id="evm-legend-ev">Earned Value</h3>
                <p>total cost of the work completed/performed</p>
            </div>
            <div>
                <h3 id="evm-legend-ac">Actual Cost</h3>
                <p>total cost taken to complete the work</p>
            </div>
            <div>
                <h3 id="evm-legend-pv">Planned Value</h3>
                <p>total cost of the work scheduled/planned</p>
            </div>
        </div>
    </div>

    

    <!-- This script is the ajax way to select baselines from dropdown box -->
    <script>
            var dropdownMenu = $('#baseline_id');    //Dropdown element from html.  
            var projectId    = <%= @project.id %> ;  //The current project id;
            var baselineId   = dropdownMenu.val();   //The dropdown selected baseline id;
            
            var mainChartData;
            var mainChartHtmlElement;
            var versionsChartData;
            var verisonChartHtmlElement;

            var plannedValue;
            var earnedValue;
            var actualCost;
            var cpi;
            var spi;
            var scheduleVariance;
            var costVariance;

            var urlMainChartData;       //Get json for chart data, from baselines_controller.
            var urlVersionsChartData;   //Get json for versions chart data, from baselines_controller.
            var urlEvmVariables;        //Get json for evms data, from baselines_controller.

            var evmSpiStatusLabel      = $('#evm-spi-status-label');        //
            var evmSpiStatusPercentage = $('#evm-spi-status-percentage');   //Side bar indicator percentage and status
            var evmCpiStatusLabel      = $('#evm-cpi-status-label');        //
            var evmCpiStatusPercentage = $('#evm-cpi-status-percentage');   //

            function getEvmData(url){
                var data;
                $.ajax({
                    async: false,       //Whithout this it would not return the json data in var data, for now 
                    url: url,
                    type: "GET",
                    dataType: "json",
                    success: function(resp) {
                        data = resp
                    }
                });
                console.log(data);      //DEBUG Remove after
                return data;
            }

            function renderEvmData(){
                urlMainChartData        = '/projects/' + projectId + '/baselines/' + baselineId + '/chart_data';
                urlVersionsChartData    = '/projects/' + projectId + '/baselines/' + baselineId + '/versions_chart_data';
                urlEvmVariables         = '/projects/' + projectId + '/baselines/' + baselineId + '/evm_variables';

                //Draw the main Chart.
                mainChartData = getEvmData(urlMainChartData);
                mainChartHtmlElement = 'evm-graph-lines-' + baselineId;
                $('#evm-main-chart').html(
                    '<div id=' + mainChartHtmlElement + ' style="width:70%;height:350px;margin:auto;"></div>'
                );
                drawChart(mainChartData, mainChartHtmlElement);

                //Draw versions Charts
                versionsChartContainer = $('#evm-versions-charts');
                versionsChartData = getEvmData(urlVersionsChartData);
                versionsChartContainer.empty();
                $.each(versionsChartData, function(key, value) {  
                  verisonChartHtmlElement = 'evm-graph-lines-version-' + key;
                  versionsChartContainer.append(
                     '<h5>'+ versionsChartData[key].name +'</h5><div id=' + verisonChartHtmlElement + ' style="width:70%;height:350px;margin:auto;margin-top:40px;margin-bottom:40px;"></div>'
                  );
                  drawChart(value, verisonChartHtmlElement);
                });

                //Get data from baseline, CPI and SPI, Schedule Variance and Cost Variance
                evmVariables = getEvmData(urlEvmVariables);
                plannedValue = evmVariables['pv'];
                actualCost   = evmVariables['ac'];
                earnedValue  = evmVariables['ev'];

                spi = earnedValue / plannedValue ;
                cpi = earnedValue / actualCost ;

                scheduleVariance = earnedValue - plannedValue;
                costVariance     = earnedValue - actualCost;

                //Sidebar Percentage and Status
                if(scheduleVariance < 0){
                    evmSpiStatusLabel.html("behind");
                    evmSpiStatusPercentage.html(((1 - spi) * 100).toFixed(0) + '%'); 
                    //index is 0.200. 1 - 0.200 = 0.800 * 100 = 80%
                }else{   
                    evmSpiStatusLabel.html("ahead");
                    evmSpiStatusPercentage.html(((spi - 1) * 100).toFixed(0) + '%'); 
                    //index is 1.500 - 1 = 0.500 * 100 = 50%
                }

                if(costVariance < 0){
                    evmCpiStatusLabel.html("over");
                    evmCpiStatusPercentage.html(((1 - cpi) * 100).toFixed(0) + '%');
                }else{ 
                    evmCpiStatusLabel.html("under");
                    evmCpiStatusPercentage.html(((cpi - 1) * 100).toFixed(0) + '%');
                }

                //Testing area - Bar indicators in sidebar
                $('<div id="spi-pv-bar" class="bars">PV</div>').appendTo('#evm-spi-bars-container');
                $('<div id="spi-ev-bar" class="bars">EV</div>').appendTo('#evm-spi-bars-container');
                $('<div id="cpi-ev-bar" class="bars">EV</div>').appendTo('#evm-cpi-bars-container');
                $('<div id="cpi-ac-bar" class="bars">AC</div>').appendTo('#evm-cpi-bars-container');

                var maxValue = Math.max(plannedValue, actualCost, earnedValue);
                var barMaxHeight = 100;

                var spiPlannedValueBarHeight = Math.floor( (plannedValue * 100) / maxValue );
                var spiEarnedValueBarHeight  = Math.floor( (earnedValue  * 100) / maxValue );
                var cpiEarnedValueBarHeight  = Math.floor( (earnedValue  * 100) / maxValue );
                var cpiActualCostBarHeight   = Math.floor( (actualCost   * 100) / maxValue );

                $('#spi-pv-bar').css("background-color", "#0f75bc");
                $('#spi-ev-bar').css("background-color", "#8cc63f");
                $('#cpi-ev-bar').css("background-color", "#8cc63f");
                $('#cpi-ac-bar').css("background-color", "#fcb040");

                $('#spi-pv-bar').height(spiPlannedValueBarHeight);
                $('#spi-pv-bar').css("line-height", "" + spiPlannedValueBarHeight + "px"); //Alinha o "PV" no bar
                $('#spi-ev-bar').height(spiEarnedValueBarHeight);
                $('#spi-ev-bar').css("line-height", "" + spiEarnedValueBarHeight + "px");

                $('#cpi-ev-bar').height(cpiEarnedValueBarHeight);
                $('#cpi-ev-bar').css("line-height", "" + cpiEarnedValueBarHeight + "px");

                $('#cpi-ac-bar').height(cpiActualCostBarHeight);
                $('#cpi-ac-bar').css("line-height", "" + cpiActualCostBarHeight + "px");

                $('.bars').width(40);
                $('.bars').css("text-align","center");
                $('.bars').css("float","left");
            }

            //Render data from current baseline.
            renderEvmData();
                        
            //Render data after changing the baseline from dropdown menu.
            dropdownMenu.change(function() {
                baselineId = $(this).val();
                renderEvmData();
            });     
    </script>

<% else %>
    <p class="nodata"><%= l(:label_no_data) %> <%= link_to l(:label_baseline_set), new_project_baseline_path(@project, :back_url => ''), :class => 'icon icon-add' %></p>
<% end %>