<% content_for :header_tags do %>
  <%= stylesheet_link_tag 'evm', :plugin => 'redmine_evm' %>
  <%= javascript_include_tag 'moment',            :plugin => 'redmine_evm' %>
  <%= javascript_include_tag 'flot',              :plugin => 'redmine_evm' %>
  <%= javascript_include_tag 'flottime',          :plugin => 'redmine_evm' %>
  <%= javascript_include_tag 'flotlabel',         :plugin => 'redmine_evm' %>
  <%= javascript_include_tag 'flottooltip',       :plugin => 'redmine_evm' %>
  <%= javascript_include_tag 'flotdashes',        :plugin => 'redmine_evm' %>
  <%= javascript_include_tag 'drawchart',         :plugin => 'redmine_evm' %>
  <%= javascript_include_tag '../../../javascripts/select_list_move', :plugin => 'redmine_evm' %>
<% end %>

<!--Title-->
<h2 id="evm-title"><%=l(:title_evm_tab)%></h2>
<% html_title('EVM Indicators') %>
<p id="evm-subtitle"><%=l(:subtitle_evm_tab)%></p>

<!--Sidebar-->
<% if @baseline.earned_value != 0 %> <%# Sidebar only avaliable if there is EV %>
  <% content_for :sidebar do %>
    <div id="evm-summary">
      <h3><%= l(:subtitle_evm_summary) %></h3>
      <div id="evm-summary-indicators" class="sidebar-boxes">
        <div id="evm-summary-indicators-container" class="indicators-container">
          <h5><%= l(:label_project_schedule) %></h5>
          <div id="evm-spi-bars-container" class="evm-bars-container">
            <div id="evm-spi-pv-bar-container" class="bars">
              <p>PV</p>
              <div id="spi-pv-bar" class="bar"></div>
            </div>    
            <div id="evm-spi-ev-bar-container" class="bars">
              <p>EV</p>
              <div id="spi-ev-bar" class="bar"></div>
            </div>
          </div>
          <p><b><%= l(:label_the_project_is)%>
          <% if @baseline.schedule_variance < 0 %>
            <%= ((1 - @baseline.schedule_performance_index) * 100).round %>%</b><br> <%= l(:label_behind_schedule)%></p>
          <% else %>
            <%= ((@baseline.schedule_performance_index - 1) * 100).round %>%</b><br> <%= l(:label_ahead_schedule)%></p>
          <% end %>
        </div>

        <div class="indicators-container">
          <h5><%= l(:label_project_cost) %></h5>
          <div id="evm-cpi-bars-container" class="evm-bars-container">
            <div id="evm-cpi-ev-bar-container" class="bars">
              <p>EV</p>
              <div id="cpi-ev-bar" class="bar"></div>
            </div>
            <div id="evm-cpi-ac-bar-container" class="bars">
              <p>AC</p>
              <div id="cpi-ac-bar" class="bar"></div>
            </div>
          </div>
          <div id="evm-cpi-barchart"></div>
          <p><b><%= l(:label_the_project_is)%>
          <% if @baseline.cost_variance < 0 %>
            <%= ((1 - @baseline.cost_performance_index) * 100).round %>%</b><br> <%= l(:label_above_budget)%></p>
          <% else %>
            <%= ((@baseline.cost_performance_index - 1) * 100).round %>%</b><br> <%= l(:label_under_budget)%></p>
          <% end %>
        </div>
      </div>
    </div>

    <%#Add forecast%>
    <% if @forecast_is_enabled %>
      <% if @baseline.earned_value != 0 %> <%#Only when there is EV%>
        <div id="evm-forecast" >
          <h3><%= l(:subtitle_evm_forecast) %></h3>
          <div id="evm-forecast-indicators" class="sidebar-boxes" >
            <div id="evm-forecast-indicators-container" class="indicators-container">
              <p><b><%=l(:label_the_project_is_now)%> <%= (@baseline.completed_actual * 100).round %>% <%= l(:label_done)%></b>
              <br> <%=l(:label_according_to_estimate)%></p>

              <p><b><%= @baseline.estimate_to_complete.to_i %> <%=l(:label_hours_are_needed)%></b><br> <%=l(:label_to_finish_the_project)%></p>

              <p><b><%=l(:label_the_project_is_estimated)%></b><br> 
              <% if @baseline.variance_at_completion < 0 %>
                <%= @baseline.variance_at_completion.round.abs %> <%=l(:label_hours_more_than_planned)%></p>
              <%else%>
                <%= @baseline.variance_at_completion.round.abs %> <%=l(:label_hours_less_than_planned)%></p>
              <%end%>
            </div>
          </div>
        </div>
      <% end %>
    <% end %>
  <% end %>
<% end %>

<!-- Dropdown for baselines -->
<%= form_tag baseline_path, method: :get, id: 'query_form' do %>
  <fieldset id="filters" class="collapsible ">
    <legend onclick="toggleFieldset(this);"><%= l(:label_baseline_plural) %></legend>
    <div>
      <%= collection_select :baseline, :id, @baselines, :id, :name %>
      <%# select_tag "id", options_from_collection_for_select(@baselines, "id", "name") %>
    </div>
  </fieldset>

   
  <fieldset id="filters" class="collapsible collapsed">
    <legend onclick="toggleFieldset(this);"><%= l(:label_options) %></legend>
    <div style="display: none;">
      <% unless @baseline.actual_cost == 0 %>
      <%= check_box_tag 'forecast', 'true', @forecast_is_enabled  %>
      <%= label_tag 'Forecast' %>
      <% end %>
    </div>
  </fieldset>

  <p class="buttons">
    <%= link_to_function l(:button_apply), 'submit_query_form("query_form")', :class => 'icon icon-checked' %>
    <!-- submit_query_form is from redmine application.js -->
  </p>
  

<% end %>

<!--Legend-->
<div id="evm-legend-info">
  <div id="evm-legend-content">
    <div>
      <h3 id="evm-legend-pv"><%=l(:label_evm_legend_pv)%></h3>
      <p><%=l(:label_evm_legend_pv_description)%></p>
    </div>
    <div>
      <h3 id="evm-legend-ev"><%=l(:label_evm_legend_ev)%></h3>
      <p><%=l(:label_evm_legend_ev_description)%></p>
    </div>
    <div>
      <h3 id="evm-legend-ac"><%=l(:label_evm_legend_ac)%></h3>
      <p><%=l(:label_evm_legend_ac_description)%></p>
    </div>
  </div>
  <% if @forecast_is_enabled %>
    <div id="evm-legend-forecast-container">
      <div class="evm-legend-lines">
        <div id="evm-legend-actual"  style="height:0px;width:50px;border-top:3px solid grey;padding:0;margin-bottom:4px;"></div>
        <p><%=l(:label_evm_legend_actual)%></p>
      </div>
      <div class="evm-legend-lines">
        <div id="evm-legend-predicted" style="height:0px;width:50px;border-top:3px dashed grey;padding:0;margin-bottom:4px;"></div>
        <p><%=l(:label_evm_legend_predicted)%></p>
      </div>
    </div>
  <% end %>
</div>

<!--Charts-->
<div id="evm-charts-wrapper">
  <!-- Main Chart -->
  <div id="evm-main-chart">
    <div id='evm-graph-lines' class='evm-main-chart' style="width:70%;height:350px;margin:auto;"></div>
    <%= render :partial => '/baselines/chart_js', :locals => { project_chart_data: @project_chart_data } %>
  </div>
  <!-- Versions Charts -->
  <div id="evm-versions-charts">
    <% @project.versions.each do |version|%>
      <% version_chart_data = [] %>
      <% baseline_version = @baseline.baseline_versions.where(original_version_id: version.id, exclude: false).first %>
      <% unless baseline_version.nil? %>
        <h5><%= version.name %></h5>
        <div id='evm-graph-lines-version-<%= version.id %>' style="width:70%;height:350px;margin:auto;margin-top:40px;margin-bottom:40px;"></div>
        <% version_chart_data << convert_to_chart(baseline_version.planned_value_by_week) %>
        <% version_chart_data << convert_to_chart(version.actual_cost_by_week(@baseline.id)) %>
        <% version_chart_data << convert_to_chart(version.earned_value_by_week(@baseline.id)) %>
        <%= render :partial => '/baselines/version_chart_js', :locals => { version_chart_data: version_chart_data, version: version } %>
      <% end %>
      
    <% end %>
  </div> 
</div>

<script>
  var plannedValue = <%= @baseline.planned_value%>
  var actualCost   = <%= @baseline.actual_cost   %>
  var earnedValue  = <%= @baseline.earned_value  %>
  
  //Bar indicators and behavior from sidebar.---------------------------------------------------------------------------
  var maxValue = Math.max(plannedValue, actualCost, earnedValue);
  var barMaxHeight = 100;

  var spiPlannedValueBarHeight = Math.round((plannedValue * barMaxHeight) / maxValue);
  var earnedValueBarHeight     = Math.round((earnedValue  * barMaxHeight) / maxValue);
  var cpiActualCostBarHeight   = Math.round((actualCost   * barMaxHeight) / maxValue);

  $('#spi-pv-bar').height(spiPlannedValueBarHeight);
  $('#spi-ev-bar').height(earnedValueBarHeight);
  $('#cpi-ev-bar').height(earnedValueBarHeight);
  $('#cpi-ac-bar').height(cpiActualCostBarHeight);

  var minHeightForFont = parseInt($('.bars p').css("font-size"));
   
  //This aligns the Label inside the bars correctly when these its too small.
  if(spiPlannedValueBarHeight < minHeightForFont)
    $('#evm-spi-pv-bar-container p').css("padding-bottom", "" + spiPlannedValueBarHeight + "px");
  else $('#evm-spi-pv-bar-container p').css("line-height", "" + spiPlannedValueBarHeight + "px"); //Alinha o "PV" no bar
  if(earnedValueBarHeight < minHeightForFont){
    $('#evm-spi-ev-bar-container p').css("padding-bottom", "" + earnedValueBarHeight     + "px");
    $('#evm-cpi-ev-bar-container p').css("padding-bottom", "" + earnedValueBarHeight     + "px");
  } else {
    $('#evm-spi-ev-bar-container p').css("line-height", "" + earnedValueBarHeight     + "px");
    $('#evm-cpi-ev-bar-container p').css("line-height", "" + earnedValueBarHeight     + "px");
  }
  if(cpiActualCostBarHeight < minHeightForFont)
    $('#evm-cpi-ac-bar-container p').css("padding-bottom", "" + cpiActualCostBarHeight   + "px");
  else $('#evm-cpi-ac-bar-container p').css("line-height", "" + cpiActualCostBarHeight   + "px");
</script>

<script>
  var dropdownMenu = $('#baseline_id');               //Dropdown element from html.
  dropdownMenu.change(function() {                    //When selected.
    window.location = '/baselines/' + $(this).val();  //Redirect to selected baseline.
  });
</script>


